<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Pdf Editor</title>
    <!-- Inter font for clean typography -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        canvas {
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        #signatureCanvas {
            border: 2px dashed #d1d5db;
        }
        .message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        .pdf-page-container {
            position: relative;
            width: 100%;
            display: inline-block;
        }
        .pdf-page-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .draggable-element {
            position: absolute;
            cursor: move;
            user-select: none;
        }
        .draggable-element:hover {
            outline: 2px dashed rgba(59, 130, 246, 0.5);
        }
        .draggable-text {
            border: 1px dashed transparent;
            padding: 2px;
            white-space: pre-wrap; /* Allows line breaks */
            min-width: 20px;
            min-height: 20px;
            word-wrap: break-word; /* Breaks long words */
            font-size: 16px; /* Default font size */
        }
        .draggable-signature {
            border: 1px dashed transparent;
            background-repeat: no-repeat;
            background-size: contain;
            background-position: center;
        }
        .resizer {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border: 1px solid white;
            border-radius: 50%;
            z-index: 1;
        }
        .resizer.bottom-right {
            bottom: -5px;
            right: -5px;
            cursor: nwse-resize;
        }
        .delete-button {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 2;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1px;
            color: white;
            background-color: #ef4444;
            border-radius: 9999px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: bold;
            transform: translate(50%, -50%);
        }
        .delete-button:hover {
            background-color: #dc2626;
        }
        
        /* Responsive Sidebar Styles */
        .sidebar {
            width: 100%;
            max-width: 320px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            position: fixed;
            top: 4rem; /* Aligns sidebar below the nav bar */
            left: 0;
            bottom: 0;
            z-index: 60;
            overflow-y: auto;
        }
        .sidebar.open {
            transform: translateX(0);
        }

        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
                position: static;
                width: 320px;
                min-width: 320px;
                padding-top: 2rem;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }
            .sidebar.collapsed {
                transform: translateX(-100%);
                position: fixed;
            }
        }

        /* Main content wrapper to handle layout */
        .main-container {
            flex-grow: 1;
            display: flex;
            transition: margin-left 0.3s ease-in-out;
            margin-left: 0;
            overflow: hidden; /* Prevent horizontal scroll */
        }

        .main-container.sidebar-open {
            margin-left: 0px;
        }

        @media (max-width: 1023px) {
            .main-container.sidebar-open {
                margin-left: 0; /* No margin on mobile, sidebar will overlay */
            }
        }

        .main-content {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            position: relative;
            z-index: 10;
        }
        @media (min-width: 1024px) {
            .main-content {
                padding: 2rem;
            }
        }
        
        .watermark-controls {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 50;
            white-space: nowrap;
        }

        /* Updated Dropdown Menu for Tools */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 0.5rem;
            background-color: #fff;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            min-width: 160px;
            z-index: 50;
        }
        .dropdown-menu button {
            width: 100%;
            text-align: left;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            color: #4b5563;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .dropdown-menu button:hover {
            background-color: #f3f4f6;
        }

        .tool-button.active {
            background-color: #d1e2ff;
            color: #1e40af;
        }

        /* New styles for the Text Input Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-header h3 {
            font-size: 1.25rem;
            font-weight: bold;
        }
        .modal-header button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        #signatureModalTabs {
            display: flex;
            margin-bottom: 1rem;
        }
        .tab-button {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            border: 1px solid #d1d5db;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            background-color: #f9fafb;
            cursor: pointer;
            font-weight: 600;
            color: #4b5563;
        }
        .tab-button.active {
            background-color: #fff;
            border-bottom: 1px solid #fff;
            color: #1f2937;
        }
        #signatureCanvas {
            background-color: #fff;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col h-screen overflow-hidden">

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-lg p-4 flex justify-between items-center z-50">
        <div class="flex items-center space-x-2">
            <!-- Mobile Menu Button to toggle sidebar -->
            <button id="menuToggle" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors lg:hidden" title="Toggle Sidebar">
                <svg id="menuIcon" class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                <svg id="closeIcon" class="w-6 h-6 text-gray-800 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <span class="text-xl font-bold text-gray-900 hidden sm:block">Eco-Pdf Editor</span>
        </div>
        
        <!-- Main Nav Buttons -->
        <div class="flex-grow flex justify-end items-center space-x-2 nav-buttons">
            <!-- Desktop Sidebar Toggle Button -->
            <button id="collapseSidebarBtn" class="p-2 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors hidden lg:block" title="Toggle Sidebar">
                <svg id="collapseIcon" class="w-6 h-6 text-gray-800" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
                <svg id="expandIcon" class="w-6 h-6 text-gray-800 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
            
            <!-- Watermark Icon and Controls -->
            <div class="relative group">
                <button id="watermarkToggleBtn" class="p-2 text-gray-800 hover:bg-gray-200 rounded-full transition duration-300" title="Add Watermark">
                    <!-- New Watermark Icon -->
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9-3a9 9 0 1118 0a9 9 0 01-18 0z" />
                        <text x="50%" y="50%" dominant-baseline="central" text-anchor="middle" font-size="12" font-family="sans-serif" fill="currentColor" stroke="none" opacity="0.4">A</text>
                    </svg>
                </button>
                <div id="watermarkControls" class="watermark-controls">
                    <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-2">
                        <input type="text" id="watermarkText" placeholder="Watermark text..." class="p-2 border border-gray-300 rounded-md w-full sm:w-48">
                        <input type="range" id="watermarkOpacity" min="0" max="1" step="0.05" value="0.2" class="w-full sm:w-24">
                        <button id="addWatermarkBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 transition duration-300 w-full sm:w-auto">
                            Apply
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tools Dropdown -->
            <div class="relative inline-block text-left">
                <!-- New PDF Tools Icon -->
                <button id="toolsDropdownBtn" class="p-2 text-gray-800 hover:bg-gray-200 rounded-full transition duration-300" title="Add Tools">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m-9-3a9 9 0 1118 0a9 9 0 01-18 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
                <div id="toolsDropdownMenu" class="dropdown-menu hidden">
                    <button id="addSignatureBtn" class="tool-button">Add Signature</button>
                    <button id="addTextBtn" class="tool-button">Add Text</button>
                    <button id="addDateBtn" class="tool-button">Add Date</button>
                    <button id="addCheckboxBtn" class="tool-button">Add Checkbox</button>
                </div>
            </div>
            
            <!-- Other Buttons -->
            <span id="userStatus" class="text-gray-600 mr-2 hidden sm:block">Signed in as: <span id="userEmail">Guest</span></span>
            <button id="loginBtn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md shadow-md hover:bg-gray-300 transition duration-300 hidden sm:block">Login</button>
            <button id="authBtn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-md shadow-md hover:bg-blue-700 transition duration-300">Sign Up</button>
            <input type="file" id="pdfFile" accept=".pdf" class="hidden">
            <label for="pdfFile" class="p-2 cursor-pointer text-gray-800 hover:bg-gray-200 rounded-full transition duration-300" title="Upload PDF">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
            </label>
            <button id="downloadPdf" class="p-2 text-gray-800 hover:bg-gray-200 rounded-full transition duration-300 hidden" title="Download PDF">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            </button>
        </div>
    </nav>
    
    <!-- Main content area wrapper -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar for all controls -->
        <div id="sidebar" class="sidebar flex flex-col p-8 overflow-y-auto">
            <h1 class="text-2xl font-bold text-gray-900 mb-2 text-center">Controls</h1>
            <p class="text-gray-600 text-center mb-6">Manage your PDF and tools here.</p>
            
            <!-- Signature Preview -->
            <div id="signaturePreviewContainer" class="flex flex-col items-center mb-8 bg-gray-50 rounded-lg shadow-inner p-4">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">Your Signature</h3>
                <img id="signaturePreview" class="w-full max-h-32 object-contain cursor-grab" draggable="true" alt="Signature Preview"/>
                <p id="signaturePlaceholder" class="text-gray-400 mt-2 text-sm text-center">No signature found. Click "Add Signature" to get started!</p>
            </div>

            <!-- Mini PDF Viewer -->
            <div class="flex flex-col items-center mb-8 bg-gray-50 rounded-lg shadow-inner p-4">
                <h3 class="text-xl font-semibold mb-4 text-gray-800">PDF Preview</h3>
                <div id="miniPdfViewer" class="w-full">
                    <!-- Mini PDF pages will be rendered here -->
                </div>
            </div>

            <!-- Main controls and file upload section -->
            <div class="flex flex-col items-center justify-center space-y-4 mb-8">
                <button id="saveToCloudBtn" class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform hover:scale-105 w-full hidden">
                    Save to Cloud
                </button>
            </div>
        </div>
    
        <!-- Main Content Area for PDF Viewer -->
        <div id="main-content-wrapper" class="main-container flex-col items-center py-10 px-4 overflow-y-auto">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 text-center">PDF Viewer</h2>
            <div id="pdf-pages" class="w-full max-w-4xl bg-white rounded-xl shadow-2xl p-8 space-y-8">
                <!-- PDF pages will be rendered here dynamically -->
            </div>
        </div>
    </div>

    <!-- Message Box for user feedback -->
    <div id="messageBox" class="message-box hidden p-4 rounded-lg text-white font-bold bg-blue-500 shadow-xl transform transition-all duration-300 ease-out scale-95 opacity-0">
        <!-- Message content goes here -->
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal-overlay hidden">
        <div class="bg-white rounded-lg p-8 shadow-2xl w-full max-w-md">
            <h3 id="authModalTitle" class="text-2xl font-bold mb-4 text-center">Sign Up for Free</h3>
            <p id="authModalText" class="text-center text-gray-600 mb-6">Create an account to download and save your documents.</p>
            <div class="space-y-4">
                <input type="text" id="authEmail" class="w-full p-3 border border-gray-300 rounded-md" placeholder="Enter your email">
                <input type="password" id="authPassword" class="w-full p-3 border border-gray-300 rounded-md" placeholder="Enter your password">
                <button id="authModalBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 w-full">
                    Sign Up
                </button>
            </div>
            <p id="authMessage" class="mt-4 text-sm text-red-500 text-center"></p>
        </div>
    </div>

    <!-- Text Input Modal -->
    <div id="textInputModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Text to PDF</h3>
                <button id="textModalCloseBtn">&times;</button>
            </div>
            <textarea id="textInput" placeholder="Type your text here..." class="w-full h-24 p-2 border border-gray-300 rounded-md resize-y"></textarea>
            <div class="modal-footer">
                <button id="textModalCancelBtn" class="bg-gray-300 text-gray-800 py-2 px-4 rounded-md hover:bg-gray-400">Cancel</button>
                <button id="textModalAddBtn" class="bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">Add</button>
            </div>
        </div>
    </div>
    
    <!-- Signature Modal -->
    <div id="signatureModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-bold">Add Signature</h3>
                <button id="signatureModalCloseBtn" class="p-1">&times;</button>
            </div>
            <div id="signatureModalTabs">
                <button id="drawSignatureTab" class="tab-button active">Draw Signature</button>
                <button id="uploadSignatureTab" class="tab-button">Upload Signature</button>
            </div>

            <!-- Draw Signature Section -->
            <div id="drawSignatureSection" class="signature-tab-content">
                <canvas id="signatureCanvas" class="w-full h-48 border border-gray-300 rounded-md mb-2"></canvas>
                <button id="clearSignatureBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md hover:bg-gray-400 w-full mb-4">Clear</button>
                <button id="drawSignatureDoneBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 w-full">Done</button>
            </div>

            <!-- Upload Signature Section -->
            <div id="uploadSignatureSection" class="signature-tab-content hidden">
                <input type="file" id="signatureFile" accept="image/*" class="w-full p-2 mb-4 border border-gray-300 rounded-md">
                <img id="uploadSignaturePreview" src="" alt="Uploaded Signature Preview" class="w-full max-h-48 object-contain my-4 border border-gray-200 rounded-md hidden">
                <p id="uploadPlaceholder" class="text-gray-400 text-center text-sm">Preview will appear here after upload.</p>
                <button id="uploadSignatureDoneBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-full shadow-lg hover:bg-blue-700 transition duration-300 w-full">Done</button>
            </div>
        </div>
    </div>

    <!-- PDF.js and PDF-LIB.js Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

    <script>
        // Set the worker source for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.worker.min.js';

        // Get DOM elements
        const pdfFileEl = document.getElementById('pdfFile');
        const pdfPagesEl = document.getElementById('pdf-pages');
        const downloadPdfBtn = document.getElementById('downloadPdf');
        const saveToCloudBtn = document.getElementById('saveToCloudBtn');
        const messageBox = document.getElementById('messageBox');
        
        const watermarkToggleBtn = document.getElementById('watermarkToggleBtn');
        const watermarkControls = document.getElementById('watermarkControls');
        const watermarkTextEl = document.getElementById('watermarkText');
        const watermarkOpacityEl = document.getElementById('watermarkOpacity');
        const addWatermarkBtn = document.getElementById('addWatermarkBtn');

        const addSignatureBtn = document.getElementById('addSignatureBtn');
        const addTextBtn = document.getElementById('addTextBtn');
        const addDateBtn = document.getElementById('addDateBtn');
        const addCheckboxBtn = document.getElementById('addCheckboxBtn');

        const toolsDropdownBtn = document.getElementById('toolsDropdownBtn');
        const toolsDropdownMenu = document.getElementById('toolsDropdownMenu');

        const sidebarEl = document.getElementById('sidebar');
        const mainContainer = document.querySelector('.main-container');
        const menuToggleBtn = document.getElementById('menuToggle');
        const collapseSidebarBtn = document.getElementById('collapseSidebarBtn');
        const menuIcon = document.getElementById('menuIcon');
        const closeIcon = document.getElementById('closeIcon');
        const collapseIcon = document.getElementById('collapseIcon');
        const expandIcon = document.getElementById('expandIcon');

        const miniPdfViewerEl = document.getElementById('miniPdfViewer');

        // Signature modal elements
        const signatureModal = document.getElementById('signatureModal');
        const signatureModalCloseBtn = document.getElementById('signatureModalCloseBtn');
        const drawSignatureTab = document.getElementById('drawSignatureTab');
        const uploadSignatureTab = document.getElementById('uploadSignatureTab');
        const drawSignatureSection = document.getElementById('drawSignatureSection');
        const uploadSignatureSection = document.getElementById('uploadSignatureSection');
        const signatureCanvas = document.getElementById('signatureCanvas');
        const clearSignatureBtn = document.getElementById('clearSignatureBtn');
        const drawSignatureDoneBtn = document.getElementById('drawSignatureDoneBtn');
        const signatureFile = document.getElementById('signatureFile');
        const uploadSignaturePreview = document.getElementById('uploadSignaturePreview');
        const uploadSignatureDoneBtn = document.getElementById('uploadSignatureDoneBtn');
        const uploadPlaceholder = document.getElementById('uploadPlaceholder');

        // Sidebar signature preview elements
        const signaturePreview = document.getElementById('signaturePreview');
        const signaturePlaceholder = document.getElementById('signaturePlaceholder');

        // Text input modal elements
        const textInputModal = document.getElementById('textInputModal');
        const textInput = document.getElementById('textInput');
        const textModalCloseBtn = document.getElementById('textModalCloseBtn');
        const textModalCancelBtn = document.getElementById('textModalCancelBtn');
        const textModalAddBtn = document.getElementById('textModalAddBtn');

        // Authentication-related elements
        const loginBtn = document.getElementById('loginBtn');
        const authBtn = document.getElementById('authBtn'); // This is now the "Sign Up" button
        const userStatusEl = document.getElementById('userStatus');
        const userEmailEl = document.getElementById('userEmail');
        const authModal = document.getElementById('authModal');
        const authModalTitle = document.getElementById('authModalTitle');
        const authModalText = document.getElementById('authModalText');
        const authModalBtn = document.getElementById('authModalBtn');
        const authEmailEl = document.getElementById('authEmail');
        const authPasswordEl = document.getElementById('authPassword');
        const authMessageEl = document.getElementById('authMessage');

        // State variables for the application
        let pdfDoc = null; // The loaded PDF document from PDF.js
        let pdfLibDoc = null; // The loaded PDF document from PDF-LIB.js
        let pages = []; // Array to store page dimensions and canvases
        let signatureDataUrl = null; // The data URL of the signature image
        let activeTool = null; // Can be 'signature', 'text', 'date', 'checkbox'
        let isAuthenticated = false;
        let authMode = 'signup'; // 'signup' or 'login'
        let currentClickCoords = { x: 0, y: 0, pageIndex: 0 };
        let currentUploadedSignatureUrl = null;

        // Signature drawing state
        let isDrawing = false;
        let ctx = signatureCanvas.getContext('2d');
        ctx.lineWidth = 3;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
        
        // --- Authentication Logic ---
        function updateAuthUI() {
            if (localStorage.getItem('isAuthenticated') === 'true') {
                isAuthenticated = true;
                const email = localStorage.getItem('userEmail');
                authBtn.textContent = 'Logout';
                authBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                authBtn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                userStatusEl.classList.remove('hidden');
                userEmailEl.textContent = email || 'Guest';
                downloadPdfBtn.classList.remove('hidden');
                saveToCloudBtn.classList.remove('hidden');
                loginBtn.classList.add('hidden');
            } else {
                isAuthenticated = false;
                authBtn.textContent = 'Sign Up';
                authBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300');
                authBtn.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
                userStatusEl.classList.add('hidden');
                downloadPdfBtn.classList.add('hidden');
                saveToCloudBtn.classList.add('hidden');
                loginBtn.classList.remove('hidden');
            }
        }
        
        authBtn.addEventListener('click', () => {
            if (isAuthenticated) {
                // Logout
                localStorage.removeItem('isAuthenticated');
                localStorage.removeItem('userEmail');
                updateAuthUI();
                showMessage('Logged out successfully.', 'info');
            } else {
                // Show signup modal
                authMode = 'signup';
                authModalTitle.textContent = 'Sign Up for Free';
                authModalText.textContent = 'Create an account to download and save your documents.';
                authModalBtn.textContent = 'Sign Up';
                authMessageEl.textContent = '';
                authModal.classList.remove('hidden');
            }
        });

        loginBtn.addEventListener('click', () => {
            authMode = 'login';
            authModalTitle.textContent = 'Login to Your Account';
            authModalText.textContent = 'Login to access your saved documents.';
            authModalBtn.textContent = 'Login';
            authMessageEl.textContent = '';
            authModal.classList.remove('hidden');
        });

        authModalBtn.addEventListener('click', () => {
            const email = authEmailEl.value;
            const password = authPasswordEl.value;
            if (authMode === 'signup') {
                if (email && password.length >= 6) {
                    // Simulate signup
                    localStorage.setItem('isAuthenticated', 'true');
                    localStorage.setItem('userEmail', email);
                    updateAuthUI();
                    authModal.classList.add('hidden');
                    authEmailEl.value = '';
                    authPasswordEl.value = '';
                    showMessage('Account created and logged in!', 'success');
                } else {
                    authMessageEl.textContent = 'Please enter a valid email and a password of at least 6 characters.';
                }
            } else if (authMode === 'login') {
                const storedEmail = localStorage.getItem('userEmail');
                if (email === storedEmail && password.length >= 6) {
                    // Simulate login
                    localStorage.setItem('isAuthenticated', 'true');
                    updateAuthUI();
                    authModal.classList.add('hidden');
                    authEmailEl.value = '';
                    authPasswordEl.value = '';
                    showMessage('Logged in successfully!', 'success');
                } else {
                    authMessageEl.textContent = 'Invalid email or password.';
                }
            }
        });
        
        // Hide modal when clicking outside
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.classList.add('hidden');
            }
        });

        // Initial UI update
        updateAuthUI();

        // Function to show a temporary message box
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            let bgColor = 'bg-blue-500';
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';
            if (type === 'warn') bgColor = 'bg-yellow-500';
            messageBox.className = `message-box p-4 rounded-lg text-white font-bold shadow-xl transform transition-all duration-300 ease-out scale-100 opacity-100 ${bgColor}`;
            messageBox.classList.remove('hidden');

            setTimeout(() => {
                messageBox.classList.remove('scale-100', 'opacity-100');
                messageBox.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 300);
            }, 2000);
        }

        // --- Sidebar Logic ---
        function toggleSidebar(forceOpen) {
            const isDesktop = window.innerWidth >= 1024;
            if (isDesktop) {
                const isCollapsed = sidebarEl.classList.contains('collapsed');
                if (forceOpen === true && !isCollapsed) return;
                sidebarEl.classList.toggle('collapsed');
                mainContainer.classList.toggle('sidebar-open', !sidebarEl.classList.contains('collapsed'));
                collapseIcon.classList.toggle('hidden', !isCollapsed);
                expandIcon.classList.toggle('hidden', isCollapsed);
            } else {
                const isOpen = sidebarEl.classList.contains('open');
                if (forceOpen === false && isOpen) {
                    sidebarEl.classList.remove('open');
                    menuIcon.classList.remove('hidden');
                    closeIcon.classList.add('hidden');
                } else if (forceOpen === undefined) {
                    sidebarEl.classList.toggle('open');
                    menuIcon.classList.toggle('hidden', !isOpen);
                    closeIcon.classList.toggle('hidden', isOpen);
                }
            }
        }
        
        // Initial state for desktop based on the presence of the sidebar
        if (window.innerWidth >= 1024) {
            mainContainer.classList.add('sidebar-open');
        }

        menuToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });
        collapseSidebarBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleSidebar();
        });

        // Event listener to close the mobile sidebar when clicking on the main content area
        document.body.addEventListener('click', (e) => {
            if (window.innerWidth < 1024 && sidebarEl.classList.contains('open') && !sidebarEl.contains(e.target) && !menuToggleBtn.contains(e.target)) {
                toggleSidebar(false);
            }
        });

        // --- Watermark Controls Logic ---
        watermarkToggleBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            watermarkControls.style.display = watermarkControls.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e) => {
            if (!watermarkToggleBtn.contains(e.target) && !watermarkControls.contains(e.target)) {
                watermarkControls.style.display = 'none';
            }
        });

        addWatermarkBtn.addEventListener('click', async () => {
            if (!pdfLibDoc) {
                showMessage('Please upload a PDF first.', 'error');
                return;
            }
            const watermarkText = watermarkTextEl.value;
            if (!watermarkText) {
                showMessage('Please enter watermark text.', 'warn');
                return;
            }
            
            showMessage('Adding watermark to PDF...', 'info');
            const { degrees } = PDFLib;
            const helveticaFont = await pdfLibDoc.embedFont(PDFLib.StandardFonts.Helvetica);
            const pagesToWatermark = pdfLibDoc.getPages();
            const opacity = parseFloat(watermarkOpacityEl.value);

            for (const page of pagesToWatermark) {
                const { width, height } = page.getSize();
                const textWidth = helveticaFont.widthOfTextAtSize(watermarkText, 50);
                
                page.drawText(watermarkText, {
                    x: (width / 2) - (textWidth / 2),
                    y: (height / 2),
                    size: 50,
                    font: helveticaFont,
                    color: PDFLib.rgb(0.5, 0.5, 0.5),
                    opacity: opacity,
                    rotate: degrees(-45),
                });
            }
            showMessage('Watermark added!', 'success');
        });

        // --- Tools Dropdown Logic ---
        toolsDropdownBtn.addEventListener('click', () => {
            toolsDropdownMenu.classList.toggle('hidden');
        });
        document.addEventListener('click', (e) => {
            if (!toolsDropdownBtn.contains(e.target) && !toolsDropdownMenu.contains(e.target)) {
                toolsDropdownMenu.classList.add('hidden');
            }
        });

        // --- PDF Logic ---
        async function renderPdf(pdfBytes) {
            try {
                pdfDoc = await pdfjsLib.getDocument({ data: pdfBytes }).promise;
                pdfLibDoc = await PDFLib.PDFDocument.load(pdfBytes);
                pdfPagesEl.innerHTML = '';
                miniPdfViewerEl.innerHTML = '';
                pages = [];
                toggleSidebar(false); // Auto-hide sidebar on file upload
                
                for (let i = 1; i <= pdfDoc.numPages; i++) {
                    // Render to main viewer
                    const page = await pdfDoc.getPage(i);
                    const viewport = page.getViewport({ scale: 1.5 });
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    const canvasEl = document.createElement('canvas');
                    const context = canvasEl.getContext('2d');
                    canvasEl.height = viewport.height;
                    canvasEl.width = viewport.width;
                    canvasEl.className = 'w-full mb-4 shadow-md rounded-lg border-2 border-gray-200';
                    const overlay = document.createElement('div');
                    overlay.className = 'pdf-page-overlay';
                    await page.render({ canvasContext: context, viewport }).promise;
                    
                    pageContainer.appendChild(canvasEl);
                    pageContainer.appendChild(overlay);
                    pdfPagesEl.appendChild(pageContainer);
                    
                    pages.push({ canvas: canvasEl, overlay: overlay, width: viewport.width, height: viewport.height, pageIndex: i - 1, pdfPage: page });
                    overlay.addEventListener('click', (e) => handleOverlayClick(e, pages[i - 1]));
                    
                    // Add drag and drop listeners to the overlay
                    overlay.addEventListener('dragover', (e) => {
                        e.preventDefault(); // This is crucial to allow the drop
                        overlay.style.outline = '2px dashed #3b82f6';
                    });
                    overlay.addEventListener('dragleave', () => {
                        overlay.style.outline = 'none';
                    });
                    overlay.addEventListener('drop', (e) => handleDrop(e, pages[i-1]));


                    // Render to mini viewer
                    const miniCanvas = document.createElement('canvas');
                    miniCanvas.className = 'mini-pdf-page';
                    const miniViewport = page.getViewport({ scale: 0.3 });
                    miniCanvas.height = miniViewport.height;
                    miniCanvas.width = miniViewport.width;
                    const miniContext = miniCanvas.getContext('2d');
                    await page.render({ canvasContext: miniContext, viewport: miniViewport }).promise;
                    miniPdfViewerEl.appendChild(miniCanvas);
                }
                updateAuthUI(); // Update UI to show download/save buttons if signed in
                showMessage('PDF loaded. Select a tool or drag your signature to add content!', 'success');

            } catch (error) {
                console.error("Error rendering PDF:", error);
                showMessage('Error loading PDF. Please try a different file.', 'error');
            }
        }
        pdfFileEl.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    const pdfBytes = new Uint8Array(event.target.result);
                    await renderPdf(pdfBytes);
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // --- Drag & Resize Logic ---
        function makeDraggable(element, disableSave = false) {
            let isDragging = false;
            let currentX, currentY, initialX, initialY, xOffset = 0, yOffset = 0;
            element.addEventListener('mousedown', dragStart);
            element.addEventListener('mouseup', dragEnd);
            element.addEventListener('mousemove', drag);
            element.addEventListener('touchstart', dragStart);
            element.addEventListener('touchend', dragEnd);
            element.addEventListener('touchmove', drag);
            function dragStart(e) {
                if (e.target.classList.contains('resizer') || e.target.classList.contains('delete-button')) { return; }
                isDragging = true;
                if (e.type === 'touchstart') {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }
            }
            function dragEnd(e) {
                if (isDragging && !disableSave) {
                }
                isDragging = false;
            }
            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }
                xOffset = currentX;
                yOffset = currentY;
                element.style.transform = `translate3d(${currentX}px, ${currentY}px, 0)`;
            }

            // Add a delete button to the element
            // This is the core functionality requested by the user.
            const deleteBtn = document.createElement('div');
            deleteBtn.className = 'delete-button';
            deleteBtn.textContent = 'âœ•';
            element.appendChild(deleteBtn);

            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                element.remove();
                showMessage('Element deleted.', 'info');
            });
        }
        function makeResizable(element) {
            const resizer = document.createElement('div');
            resizer.className = 'resizer bottom-right';
            element.appendChild(resizer);
            let initialX, initialY, initialWidth, initialHeight;
            resizer.addEventListener('mousedown', initResize);
            resizer.addEventListener('touchstart', initResize);
            function initResize(e) {
                e.preventDefault();
                e.stopPropagation();
                initialX = e.clientX || e.touches[0].clientX;
                initialY = e.clientY || e.touches[0].clientY;
                initialWidth = element.offsetWidth;
                initialHeight = element.offsetHeight;
                window.addEventListener('mousemove', resize);
                window.addEventListener('mouseup', stopResize);
                window.addEventListener('touchmove', resize);
                window.addEventListener('touchend', stopResize);
            }
            function resize(e) {
                const currentX = e.clientX || e.touches[0].clientX;
                const currentY = e.clientY || e.touches[0].clientY;
                const newWidth = initialWidth + (currentX - initialX);
                const newHeight = initialHeight + (currentY - initialY);
                element.style.width = newWidth + 'px';
                element.style.height = newHeight + 'px';
            }
            function stopResize() {
                window.removeEventListener('mousemove', resize);
                window.removeEventListener('mouseup', stopResize);
                window.removeEventListener('touchmove', resize);
                window.removeEventListener('touchend', stopResize);
            }
        }


        // --- Tool Management & Placement Logic ---
        function setActiveTool(tool) {
            activeTool = tool;
            document.querySelectorAll('.tool-button').forEach(btn => btn.classList.remove('active'));
            if (tool) {
                document.getElementById(`add${tool.charAt(0).toUpperCase() + tool.slice(1)}Btn`).classList.add('active');
            }
        }
        
        addSignatureBtn.addEventListener('click', () => {
            if (!pdfLibDoc) { showMessage('Please upload a PDF first.', 'error'); return; }
            setActiveTool('signature');
            toolsDropdownMenu.classList.add('hidden');
            signatureModal.classList.remove('hidden');
        });
        
        addTextBtn.addEventListener('click', () => {
            if (!pdfLibDoc) { showMessage('Please upload a PDF first.', 'error'); return; }
            setActiveTool('text');
            showMessage('Text tool selected. Click on a page to add text.');
            toolsDropdownMenu.classList.add('hidden');
        });
        
        addDateBtn.addEventListener('click', () => {
            if (!pdfLibDoc) { showMessage('Please upload a PDF first.', 'error'); return; }
            setActiveTool('date');
            showMessage('Date tool selected. Click on a page to add the date.');
            toolsDropdownMenu.classList.add('hidden');
        });

        addCheckboxBtn.addEventListener('click', () => {
            if (!pdfLibDoc) { showMessage('Please upload a PDF first.', 'error'); return; }
            setActiveTool('checkbox');
            showMessage('Checkbox tool selected. Click on a page to add a checkbox.');
            toolsDropdownMenu.classList.add('hidden');
        });

        // --- Signature Modal Logic ---
        signatureModalCloseBtn.addEventListener('click', () => {
            signatureModal.classList.add('hidden');
        });

        drawSignatureTab.addEventListener('click', () => {
            drawSignatureTab.classList.add('active');
            uploadSignatureTab.classList.remove('active');
            drawSignatureSection.classList.remove('hidden');
            uploadSignatureSection.classList.add('hidden');
        });

        uploadSignatureTab.addEventListener('click', () => {
            uploadSignatureTab.classList.add('active');
            drawSignatureTab.classList.remove('active');
            uploadSignatureSection.classList.remove('hidden');
            drawSignatureSection.classList.add('hidden');
        });
        
        // Drawing functionality
        signatureCanvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(e.offsetX, e.offsetY);
        });
        signatureCanvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            ctx.lineTo(e.offsetX, e.offsetY);
            ctx.stroke();
        });
        signatureCanvas.addEventListener('mouseup', () => {
            isDrawing = false;
        });
        signatureCanvas.addEventListener('mouseout', () => {
            isDrawing = false;
        });

        // Touch drawing functionality
        signatureCanvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = signatureCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
        });
        signatureCanvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isDrawing) return;
            const touch = e.touches[0];
            const rect = signatureCanvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            ctx.lineTo(x, y);
            ctx.stroke();
        });
        signatureCanvas.addEventListener('touchend', () => {
            isDrawing = false;
        });

        clearSignatureBtn.addEventListener('click', () => {
            ctx.clearRect(0, 0, signatureCanvas.width, signatureCanvas.height);
        });

        drawSignatureDoneBtn.addEventListener('click', () => {
            const isEmpty = signatureCanvas.getContext('2d').getImageData(0, 0, signatureCanvas.width, signatureCanvas.height).data.every(pixel => pixel === 0);
            if (isEmpty) {
                showMessage('Please draw a signature first.', 'warn');
                return;
            }
            signatureDataUrl = signatureCanvas.toDataURL();
            signaturePreview.src = signatureDataUrl;
            signaturePlaceholder.classList.add('hidden');
            signatureModal.classList.add('hidden');
            showMessage('Signature saved! You can now drag and drop it onto the PDF.', 'success');
        });

        // Upload functionality
        signatureFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    currentUploadedSignatureUrl = event.target.result;
                    uploadSignaturePreview.src = currentUploadedSignatureUrl;
                    uploadSignaturePreview.classList.remove('hidden');
                    uploadPlaceholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        uploadSignatureDoneBtn.addEventListener('click', () => {
            if (!currentUploadedSignatureUrl) {
                showMessage('Please upload a signature file first.', 'warn');
                return;
            }
            signatureDataUrl = currentUploadedSignatureUrl;
            signaturePreview.src = signatureDataUrl;
            signaturePlaceholder.classList.add('hidden');
            signatureModal.classList.add('hidden');
            showMessage('Signature saved! You can now drag and drop it onto the PDF.', 'success');
        });

        // --- Drag and Drop for Signature ---
        signaturePreview.addEventListener('dragstart', (e) => {
            if (signatureDataUrl) {
                e.dataTransfer.setData('text/plain', 'signature');
            } else {
                e.preventDefault();
                showMessage('Please add a signature first.', 'error');
            }
        });

        function handleDrop(e, pageInfo) {
            e.preventDefault();
            pageInfo.overlay.style.outline = 'none'; // Remove outline on drop
            
            const dropData = e.dataTransfer.getData('text/plain');
            if (dropData !== 'signature') return;
            
            if (!pdfLibDoc || !signatureDataUrl) {
                showMessage('Please upload a PDF and a signature first.', 'error');
                return;
            }

            const rect = pageInfo.overlay.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            const newElement = document.createElement('div');
            newElement.className = 'draggable-element draggable-signature';
            newElement.style.backgroundImage = `url(${signatureDataUrl})`;
            newElement.style.width = '100px';
            newElement.style.height = '50px';
            newElement.style.left = `${x}px`;
            newElement.style.top = `${y}px`;
            
            makeDraggable(newElement);
            makeResizable(newElement);
            pageInfo.overlay.appendChild(newElement);
            showMessage('Signature added!', 'success');
        }

        // --- Text Input Modal Logic ---
        textInputModal.addEventListener('click', (e) => {
            if (e.target === textInputModal) {
                textInputModal.classList.add('hidden');
            }
        });
        textModalCloseBtn.addEventListener('click', () => {
            textInputModal.classList.add('hidden');
        });
        textModalCancelBtn.addEventListener('click', () => {
            textInputModal.classList.add('hidden');
        });
        textModalAddBtn.addEventListener('click', () => {
            const textContent = textInput.value;
            if (textContent.trim() === '') {
                showMessage('Text field cannot be empty.', 'warn');
                return;
            }
            textInputModal.classList.add('hidden');
            addTextElement(textContent, currentClickCoords.pageIndex, currentClickCoords.x, currentClickCoords.y);
        });

        function addTextElement(textContent, pageIndex, x, y) {
            const newElement = document.createElement('div');
            newElement.className = 'draggable-element draggable-text';
            newElement.textContent = textContent;
            newElement.style.left = `${x}px`;
            newElement.style.top = `${y}px`;
            makeDraggable(newElement);
            makeResizable(newElement);
            pages[pageIndex].overlay.appendChild(newElement);
        }

        function handleOverlayClick(e, pageInfo) {
            if (e.target.classList.contains('draggable-element') || e.target.classList.contains('resizer') || e.target.classList.contains('delete-button')) { return; }
            if (!activeTool) { showMessage('Please select a tool first.', 'error'); return; }
            
            const clickX = e.clientX - pageInfo.overlay.getBoundingClientRect().left;
            const clickY = e.clientY - pageInfo.overlay.getBoundingClientRect().top;
            
            if (activeTool === 'text') {
                currentClickCoords.x = clickX;
                currentClickCoords.y = clickY;
                currentClickCoords.pageIndex = pageInfo.pageIndex;
                textInput.value = ''; // Clear previous text
                textInputModal.classList.remove('hidden');
                return;
            }

            let newElement;
            switch (activeTool) {
                case 'signature':
                    // User is now instructed to drag and drop. This case is kept for older devices/less intuitive users.
                    if (!signatureDataUrl) { showMessage('Please add a signature first.', 'error'); return; }
                    newElement = document.createElement('div');
                    newElement.className = 'draggable-element draggable-signature';
                    newElement.style.backgroundImage = `url(${signatureDataUrl})`;
                    newElement.style.width = '100px';
                    newElement.style.height = '50px';
                    makeResizable(newElement);
                    break;
                case 'date':
                    const today = new Date().toLocaleDateString();
                    newElement = document.createElement('div');
                    newElement.className = 'draggable-element draggable-text';
                    newElement.textContent = today;
                    newElement.style.fontSize = '12px';
                    makeResizable(newElement);
                    break;
                case 'checkbox':
                    newElement = document.createElement('div');
                    newElement.className = 'draggable-element';
                    newElement.style.width = '20px';
                    newElement.style.height = '20px';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    newElement.appendChild(checkbox);
                    break;
            }

            if (newElement) {
                newElement.style.left = `${clickX}px`;
                newElement.style.top = `${clickY}px`;
                makeDraggable(newElement);
                pageInfo.overlay.appendChild(newElement);
            }
        }

        // --- Final PDF Generation and Download/Upload ---
        async function generatePdf() {
            if (!pdfLibDoc) { showMessage('No PDF loaded to generate.', 'error'); return null; }
            try {
                const newPdfDoc = await PDFLib.PDFDocument.create();
                const pagesToCopy = pdfLibDoc.getPages();

                for (let i = 0; i < pagesToCopy.length; i++) {
                    const pageInfo = pages[i];
                    const page = newPdfDoc.addPage(pagesToCopy[i].getMediaBox());
                    
                    const elements = pageInfo.overlay.querySelectorAll('.draggable-element');
                    for (const element of elements) {
                        const style = window.getComputedStyle(element);
                        const transform = style.transform;
                        const matrix = new DOMMatrixReadOnly(transform);
                        const x = element.offsetLeft + matrix.m41;
                        const y = element.offsetTop + matrix.m42;
                        const elementWidth = element.offsetWidth;
                        const elementHeight = element.offsetHeight;
                        
                        const pdfX = (x / pageInfo.overlay.offsetWidth) * page.getWidth();
                        const pdfY = page.getHeight() - ((y + elementHeight) / pageInfo.overlay.offsetHeight) * page.getHeight();

                        if (element.classList.contains('draggable-signature')) {
                            let signatureImage = null;
                            const bgImage = style.backgroundImage.slice(5, -2);
                            if (bgImage.startsWith('data:image/jpeg')) {
                                signatureImage = await newPdfDoc.embedJpg(bgImage);
                            } else if (bgImage.startsWith('data:image/png')) {
                                signatureImage = await newPdfDoc.embedPng(bgImage);
                            }

                            if (signatureImage) {
                                page.drawImage(signatureImage, {
                                    x: pdfX,
                                    y: pdfY,
                                    width: elementWidth,
                                    height: elementHeight,
                                });
                            }
                        } else if (element.classList.contains('draggable-text')) {
                            const text = element.textContent;
                            page.drawText(text, {
                                x: pdfX,
                                y: pdfY,
                                size: parseFloat(style.fontSize),
                                font: await newPdfDoc.embedFont(PDFLib.StandardFonts.Helvetica),
                            });
                        } else {
                            const checkbox = element.querySelector('input[type="checkbox"]');
                            if (checkbox && checkbox.checked) {
                                page.drawRectangle({
                                    x: pdfX,
                                    y: pdfY,
                                    width: elementWidth,
                                    height: elementHeight,
                                    borderWidth: 1,
                                    borderColor: PDFLib.rgb(0, 0, 0),
                                });
                                page.drawText('âœ”', {
                                    x: pdfX + 2,
                                    y: pdfY,
                                    size: elementWidth,
                                    font: await newPdfDoc.embedFont(PDFLib.StandardFonts.Helvetica),
                                });
                            }
                        }
                    }
                }
                return await newPdfDoc.save();
            } catch (error) {
                console.error('Error generating PDF:', error);
                showMessage('An error occurred during PDF generation. Please try again.', 'error');
                return null;
            }
        }
        
        downloadPdfBtn.addEventListener('click', async () => {
            if (!isAuthenticated) { showMessage('Please sign up to download.', 'warn'); return; }
            showMessage('Generating PDF for download...', 'info');
            const modifiedPdfBytes = await generatePdf();
            if (!modifiedPdfBytes) return;
            const modifiedPdfBlob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
            const modifiedPdfUrl = URL.createObjectURL(modifiedPdfBlob);
            const a = document.createElement('a');
            a.href = modifiedPdfUrl;
            a.download = 'signed_and_edited_document.pdf';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(modifiedPdfUrl);
            showMessage('PDF is ready for download.', 'success');
        });
        
        saveToCloudBtn.addEventListener('click', async () => {
            if (!isAuthenticated) { showMessage('Please sign up to save to the cloud.', 'warn'); return; }
            showMessage('Generating and uploading PDF...', 'info');
            const modifiedPdfBytes = await generatePdf();
            if (!modifiedPdfBytes) return;
            const modifiedPdfBlob = new Blob([modifiedPdfBytes], { type: 'application/pdf' });
            setTimeout(() => {
                showMessage('PDF successfully uploaded!', 'success');
                console.log('Simulated upload completed. Blob size:', modifiedPdfBlob.size, 'bytes');
            }, 2000);
        });

    </script>
</body>
</html>
